<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –æ—Ç–∑—ã–≤–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .filter-btn {
            margin: 5px;
        }
        .active-filter {
            background-color: #0d6efd !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üìä –î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–∑—ã–≤–æ–≤</h1>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h4 id="total-reviews">0</h4>
                        <p class="mb-0">–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h4 id="unique-topics">0</h4>
                        <p class="mb-0">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h4 id="unique-sentiments">0</h4>
                        <p class="mb-0">–¢–∏–ø–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-section">
            <h5 class="mb-3">üîç –§–∏–ª—å—Ç—Ä—ã</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:</h6>
                    <div id="sentiment-filters" class="mb-3">
                        <button class="btn btn-outline-primary filter-btn active-filter" onclick="filterData('sentiment', null)">–í—Å–µ</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>–¢–µ–º—ã:</h6>
                    <div id="topic-filters" class="mb-3">
                        <button class="btn btn-outline-primary filter-btn active-filter" onclick="filterData('topic', null)">–í—Å–µ</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-warning" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <button class="btn btn-success" onclick="loadData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è–º</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="dataTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–¢–µ–º—ã</th>
                                <th>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allData = null;
        let currentFilters = {
            sentiment: null,
            topic: null
        };
        let sentimentChart = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadData();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function initializeCharts() {
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');

            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#28a745', // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ
                            '#dc3545', // –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ  
                            '#ffc107', // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
                            '#17a2b8',
                            '#6610f2',
                            '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadData() {
            try {
                const params = new URLSearchParams();
                if (currentFilters.topic) params.append('topic', currentFilters.topic);
                if (currentFilters.sentiment) params.append('sentiment', currentFilters.sentiment);

                const response = await fetch(`/api/get-data?${params.toString()}`);
                const data = await response.json();

                if (response.ok) {
                    allData = data;
                    updateUI(data);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', data.error);
                    showNoDataMessage();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                showNoDataMessage();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI(data) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('total-reviews').textContent = data.total_count;
            document.getElementById('unique-topics').textContent = data.all_topics.length;
            document.getElementById('unique-sentiments').textContent = data.all_sentiments.length;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            updateFilters(data.all_sentiments, data.all_topics);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            updateCharts(data.chart_data);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
            updateTable(data.predictions);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters(sentiments, topics) {
            const sentimentFilters = document.getElementById('sentiment-filters');
            const topicFilters = document.getElementById('topic-filters');

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏ "–í—Å–µ")
            sentimentFilters.innerHTML = '<button class="btn btn-outline-primary filter-btn" onclick="filterData(\'sentiment\', null)">–í—Å–µ</button>';
            topicFilters.innerHTML = '<button class="btn btn-outline-primary filter-btn" onclick="filterData(\'topic\', null)">–í—Å–µ</button>';

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            sentiments.forEach(sentiment => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary filter-btn';
                button.onclick = () => filterData('sentiment', sentiment);
                button.textContent = sentiment;
                sentimentFilters.appendChild(button);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Ç–µ–º
            topics.forEach(topic => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary filter-btn';
                button.onclick = () => filterData('topic', topic);
                button.textContent = topic;
                topicFilters.appendChild(button);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            updateActiveFilters();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateActiveFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active-filter');
            });

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const text = btn.textContent;
                if ((currentFilters.sentiment === null && text === '–í—Å–µ' && btn.onclick.toString().includes('sentiment')) ||
                    (currentFilters.topic === null && text === '–í—Å–µ' && btn.onclick.toString().includes('topic')) ||
                    text === currentFilters.sentiment ||
                    text === currentFilters.topic) {
                    btn.classList.add('active-filter');
                }
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        function filterData(filterType, value) {
            currentFilters[filterType] = value;
            updateActiveFilters();
            loadData();
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            currentFilters = { sentiment: null, topic: null };
            updateActiveFilters();
            loadData();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        function updateCharts(chartData) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            if (chartData.sentiment_data.labels.length > 0) {
                sentimentChart.data.labels = chartData.sentiment_data.labels;
                sentimentChart.data.datasets[0].data = chartData.sentiment_data.values;
                sentimentChart.update();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function updateTable(predictions) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            predictions.forEach(prediction => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = prediction.id;
                row.insertCell(1).textContent = prediction.topics ? prediction.topics.join(', ') : '';
                row.insertCell(2).textContent = prediction.sentiments ? prediction.sentiments.join(', ') : '';
            });
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        function showNoDataMessage() {
            document.getElementById('total-reviews').textContent = '0';
            document.getElementById('unique-topics').textContent = '0';
            document.getElementById('unique-sentiments').textContent = '0';
            
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
        }
    </script>
</body>
</html>
